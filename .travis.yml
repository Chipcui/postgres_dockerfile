sudo: required
services:
  - docker

env:
  global:
    - IMAGE_NAME=breedbase/pg
    - secure: "Mx7ZGpd+pQArABcBS5ZA4s26imqrQ9D1khA3xwMbEkhEltHnYknGQqE/ggNIYlKsqndmJ182vnjitLtWlMG04S6fsKQeXC6eaNEdjBCXf77lFfCy3ItndoyS3McfAGthERryseDfv5gnl153RD0P1bZ1+rFh8m+QLO0iMYSCvdWel87ccV9MhErtkNrQN/AmCa9BJ4UN0933/HCueIfVi2VGWcGG+xsMgu7n5f9bM9nSFFPWNfe3eK6gFsqD4MKbvza/RHiboA5rZIZTF9J0V2LGK2scdIxD7ZfRN0DLqTKCzyaVuQHoUiXjeq4qjsfC/31z3UpSMFzdIG48NMoXZixzab98vckuI63PRTt65hmbFghKGJHrgFT12w4ha1y+LdvT2NnIXPkrNm6IR+0jwhoHPLCFZL2ALZPHDPVu2bcUS5j/lPm2iBxUhT3xQ+d18BquWUlbH81JAGPFNPoXbiLu5vzV+DMssl6vZJjGXFrBTvpoIBFfvKijnH5+tcovhjP+YOrLlo7bYDhlfPLm08piZv30cbG1D45wAfpBLeON/ApT1RqPKAlHFo4hUYYwr91V0O48sMU5qOUkTlnwhg2ka8feRfJGp957gRJEOuIHTqcV5lG7icmab5u/OYXpKD9mgG2zC/XxWm9DOLFMXTAkh5+S2JNT/EA2f6m13EI="

branches:
  only:
    - master

before_script:
  - docker pull "$IMAGE_NAME" || true

script:
  - docker build --pull --cache-from "$IMAGE_NAME" --tag "$IMAGE_NAME" .

after_script:
  - docker images

before_deploy:
  - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
  - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:latest"
  - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:${TRAVIS_BUILD_NUMBER}"

deploy:
  provider: script
  script: docker push "${IMAGE_NAME}:latest" && docker push "${IMAGE_NAME}:${TRAVIS_BUILD_NUMBER}"
  on:
    branch: master